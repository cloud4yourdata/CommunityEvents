# SQL 2022 Demo 2

## Demo002_SurrogateKeys -Databricks

#### Create database (Skip on Demo)

```sql
CREATE DATABASE IF NOT EXISTS SQLDay2022 LOCATION 'dbfs:/mnt/datalake/analytics_zone/DWHS/SQLDay2022'
```

```sql
USE SQLDay2022;
```



#### monotonically_increasing_id -demo

##### Drop table if exists

```sql
DROP TABLE IF EXISTS SurrogateKeyDemo1;
```

##### Create table

```sql
CREATE OR REPLACE TABLE SurrogateKeyDemo1 (
 Sk BIGINT COMMENT 'SURROGATE KEY',
 Id BIGINT,
 Val DOUBLE,
 Part BIGINT 
) USING DELTA
PARTITIONED BY (PART)
```

##### Generate sample data

```sql
SET sampledata.nrows = 10000;
SET sampledata.npartitions = 4;
WITH SampleData 
(
 SELECT
 Id,
 rand() AS Val
 FROM
    RANGE(0, ${sampledata.nrows}, 1, ${sampledata.npartitions})
)
INSERT INTO SurrogateKeyDemo1
SELECT monotonically_increasing_id() as Sk,Id,Val, Id %100 AS Part FROM SampleData 
```

##### Generate more sample data (new dataset)

```sql
WITH SampleData 
(
 SELECT
 Id,
 rand() AS Val
 FROM
    RANGE(0, ${sampledata.nrows}, 1, ${sampledata.npartitions})
)
INSERT INTO SurrogateKeyDemo1
SELECT monotonically_increasing_id() as Sk,Id,Val, Id %100 AS Part FROM SampleData 
```

##### Check SK

```sql
SELECT count(*), count(DISTINCT Sk) FROM SurrogateKeyDemo1
```

##### Clear table

```sql
TRUNCATE TABLE SurrogateKeyDemo1;
```

##### Insert sample data

```sql
WITH SampleData (
  SELECT
    Id,
    rand() AS Val
  FROM
    RANGE(
      0,
      ${sampledata.nrows},
      1,
      ${sampledata.npartitions}
    )
)
INSERT INTO
  SurrogateKeyDemo1
SELECT
  monotonically_increasing_id() +  (
    SELECT
      IFNULL(MAX(Sk),0) + 1 AS LastSk
    FROM
      SurrogateKeyDemo1
  ) AS Sk,
  Id,
  Val,
  Id % 100 AS Part
FROM
  SampleData
```

##### Insert more sample data

```sql
WITH SampleData (
  SELECT
    Id,
    rand() AS Val
  FROM
    RANGE(
      0,
      ${sampledata.nrows},
      1,
      ${sampledata.npartitions}
    )
)
INSERT INTO
  SurrogateKeyDemo1
SELECT
  monotonically_increasing_id() +  (
    SELECT
      IFNULL(MAX(Sk),0) + 1 AS LastSk
    FROM
      SurrogateKeyDemo1
  ) AS Sk,
  Id,
  Val,
  Id % 100 AS Part
FROM
  SampleData
```

##### Check SK

```sql
SELECT count(*), count(DISTINCT Sk) FROM SurrogateKeyDemo1
```

#### GENERATED COLUMNS -Demo

##### Drop table

```sql
DROP TABLE IF EXISTS SurrogateKeyDemo2;
```

##### Create table

```sql
CREATE OR REPLACE TABLE SurrogateKeyDemo2 (
 Sk BIGINT  GENERATED BY DEFAULT AS IDENTITY ( START WITH 0 INCREMENT BY 1) COMMENT 'SURROGATE KEY',
 Id BIGINT,
 Val DOUBLE,
 Part BIGINT GENERATED ALWAYS AS (Id % 100)
) USING DELTA
PARTITIONED BY (Part)
```

##### Insert sample data

```sql
WITH SampleData (
  SELECT
    Id,
    rand() AS Val
  FROM
    RANGE(
      0,
      ${sampledata.nrows},
      1,
      ${sampledata.npartitions}
    )
)
INSERT INTO
  SurrogateKeyDemo2(Id,Val)
SELECT
  Id,
  Val
FROM
  SampleData
```

##### Insert more sample data

```sql
WITH SampleData (
  SELECT
    Id,
    rand() AS Val
  FROM
    RANGE(
      0,
      ${sampledata.nrows},
      1,
      ${sampledata.npartitions}
    )
)
INSERT INTO
  SurrogateKeyDemo2(Id,Val)
SELECT
  Id,
  Val
FROM
  SampleData
```

##### Check SK

```sql
SELECT count(*), count(DISTINCT Sk),MIN(Sk),MAX(Sk) FROM SurrogateKeyDemo2
```

```sql
SELECT * FROM SurrogateKeyDemo2
```

